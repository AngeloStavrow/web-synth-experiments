<!-- Look, a web synth based on https://code.tutsplus.com/tutorials/the-web-audio-api-make-your-own-web-synthesizer--cms-23887 -->

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>üé∂ Doo be do be doooooo üé∂</title>
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <div class="container">
      <h1>
        Experiments in <a href="https://webaudio.github.io/web-audio-api/">web-audio</a> üéπ&rarr;üéõÔ∏è&rarr;üîä
      </h1>
    </div>
    
    
    <div class="synth-container">

      <form>

        <div class="control-strip">
          <h2>
            Angeloog X200
          </h2>

          <div class="control-section">
            <h2>Oscillators</h2>
            <div class="oscillator-element" id="osc1">
              <label>Oscillator 1 type <select id="osc1_type">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="triangle">Triangle</option>
              </select></label>
            </div>

            <div class="oscillator-element" id="osc2">
              <label>Oscillator 2 type <select id="osc2_type">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="triangle">Triangle</option>
              </select></label>
            </div>

            <h2>Effects</h2>
            <div class="effects-element" id="effects">
              <label>Chorus effect <input type="checkbox" id="chorus_enabled" /></label>
            </div>
          </div>

          <div class="control-section filter" id="filter1">
            <h2>Filter 1</h2>
            <label>Filter type <select id="filter_type_1">
              <option value="lowpass">Lowpass</option>
              <option value="highpass">Highpass</option>
              <option value="bandpass">Bandpass</option>
              <option value="lowshelf">Lowshelf</option>
              <option value="highshelf">Highshelf</option>
              <option value="peaking">Peaking</option>
              <option value="notch">Notch</option>
              <option value="allpass">Allpass</option>
            </select></label>
            <label>Frequency (Hz)<input type="text" id="frequency_1" /></label>
            <label>Q factor <input type="text" id="q_factor_1" /></label>
            <label>Gain (dB)<input type="text" id="gain_1" /></label>
          </div>

          <div class="control-section filter" id="filter2">
            <h2>Filter 2</h2>
            <label>Filter type <select id="filter_type_2">
              <option value="lowpass">Lowpass</option>
              <option value="highpass">Highpass</option>
              <option value="bandpass">Bandpass</option>
              <option value="lowshelf">Lowshelf</option>
              <option value="highshelf">Highshelf</option>
              <option value="peaking">Peaking</option>
              <option value="notch">Notch</option>
              <option value="allpass">Allpass</option>
            </select></label>
            <label>Frequency (Hz)<input type="text" id="frequency_2" /></label>
            <label>Q factor <input type="text" id="q_factor_2" /></label>
            <label>Gain (dB)<input type="text" id="gain_2" /></label>
          </div>

          <div class="control-section filter" id="filter3">
            <h2>Filter 3</h2>
            <label>Filter type <select id="filter_type_3">
              <option value="lowpass">Lowpass</option>
              <option value="highpass">Highpass</option>
              <option value="bandpass">Bandpass</option>
              <option value="lowshelf">Lowshelf</option>
              <option value="highshelf">Highshelf</option>
              <option value="peaking">Peaking</option>
              <option value="notch">Notch</option>
              <option value="allpass">Allpass</option>
            </select></label>
            <label>Frequency (Hz)<input type="text" id="frequency_3" /></label>
            <label>Q factor <input type="text" id="q_factor_3" /></label>
            <label>Gain (dB)<input type="text" id="gain_3" /></label>
          </div>

        </div>
        
        <p>&nbsp;</p>
        <p><input type="button" name="load" value="Load" onclick="loadPreset()" /> <input type="button" name="save" value="Save" onclick="savePreset()"/></p>
      
      </form>
      
      <div id="keyboard"></div>
      
    </div>
    <script src="/qwerty-hancock.min.js"></script>
    <script src="/utils.js"></script>
    <script src="/synth.js"></script>
    <script src="/filter.js"></script>
    <script src="/preset.js"></script>
    <script>
      // Load the preset from local storage.
      function loadPreset() {
        var savedPreset = localStorage.getItem('preset');
        
        function loadFilter(i) { 
          var savedFilter = localStorage.getItem('filter' + i);
          
          if (savedFilter) {
            filter = Filter(JSON.parse(savedFilter));
            console.log(filter);
            
            return filter;
          }
        }
        
        var savedFilters = ["1", "2", "3"].map(loadFilter);

        if (savedPreset) {
          console.log('Saved preset found, loading into memory');
          preset = Preset(JSON.parse(savedPreset));
        }

        document.getElementById('osc1_type').value = preset.oscillator1.type;
        document.getElementById('osc2_type').value = preset.oscillator2.type;
        if (preset.effect === 'chorus') {
          document.getElementById('chorus_enabled').checked = true;
        }
        else {
          document.getElementById('chorus_enabled').checked = false;
        }
        
        function initializeFilterControls(i) {          
          document.getElementById('filter_type_' + i).value = savedFilters[i - 1].type;
          document.getElementById('frequency_' + i).value = savedFilters[i - 1].frequency;
          document.getElementById('q_factor_' + i).value = savedFilters[i - 1].Q;
          document.getElementById('gain_' + i).value = savedFilters[i - 1].gain;
        }
        
        [1, 2, 3].map(initializeFilterControls);
        
        function initializeFilter(filter, i) {
          filter.type = savedFilters[i].type;
          filter.frequency = parseFloat(savedFilters[i].frequency);
          filter.Q = parseFloat(savedFilters[i].Q);
          filter.gain = parseFloat(savedFilters[i].gain);
        }
        
        initializeFilter(filter1, 0);
        initializeFilter(filter2, 1);
        initializeFilter(filter3, 2);
      }
      
      // Save the preset to local storage.
      function savePreset() {
        
        preset.oscillator1.type = document.getElementById('osc1_type').value;
        preset.oscillator2.type = document.getElementById('osc2_type').value;
        
        function storeFilter(filter, i) {
          filter.type = document.getElementById('filter_type_' + i).value;
          filter.frequency = document.getElementById('frequency_' + i).value;
          filter.Q = document.getElementById('q_factor_' + i).value;
          filter.gain = document.getElementById('gain_' + i).value;
          
          localStorage.setItem('filter' + i, JSON.stringify(filter));
        }
        
        storeFilter(filter1, 1);
        storeFilter(filter2, 2);
        storeFilter(filter3, 3);
                
        if (document.getElementById('chorus_enabled').checked) {
          preset.effect = 'chorus';
        }
        else {
          preset.effect = 'none';
        }
        
        preset.setEffect();
        
        localStorage.setItem('preset', JSON.stringify(preset));
      }
      
      // Load the preset when we load the page.
      window.onload = loadPreset();
    </script>
  </body>
</html>